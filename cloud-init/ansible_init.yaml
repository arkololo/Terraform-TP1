#cloud-config
# Cloud-init pour VM Ansible
# Actions automatiques au démarrage :
# 1. Mettre à jour le système
# 2. Installer openssh-server, git, ansible
# 3. Déployer la clé privée fournie pour accès SSH vers la VM Web
# 4. Cloner le repo GitHub avec playbooks
# 5. Lancer automatiquement ansible-playbook vers VM Web

hostname: ansible
fqdn: ansible.local

# Mettre à jour les packages
package_update: true
package_upgrade: true

# Installer les paquets nécessaires
packages:
  - openssh-server
  - openssh-client
  - git
  - ansible
  - python3-pip
  - curl
  - wget

# Créer l'utilisateur ubuntu avec clé publique
users:
  - name: ubuntu
    gecos: Ubuntu User
    groups: [adm, sudo, docker]
    shell: /bin/bash
    ssh_authorized_keys:
      - ${authorized_keys}
    sudo: ['ALL=(ALL) NOPASSWD:ALL']
    lock_passwd: true
    ssh_import_id: []

# Scripts d'exécution automatique
runcmd:
  # 1. Attendre que le réseau soit stabilisé
  - sleep 10

  # 2. Créer le répertoire .ssh si nécessaire
  - mkdir -p /home/ubuntu/.ssh
  - chown ubuntu:ubuntu /home/ubuntu/.ssh
  - chmod 700 /home/ubuntu/.ssh

  # 3. Déployer la clé privée SSH (en échappant les retours à la ligne)
  - |
      cat > /home/ubuntu/.ssh/id_ed25519 <<'EOFKEY'
      ${ansible_private_key}
      EOFKEY
  - chown ubuntu:ubuntu /home/ubuntu/.ssh/id_ed25519
  - chmod 600 /home/ubuntu/.ssh/id_ed25519

  # 4. Déployer la clé publique SSH
  - echo "${ansible_public_key}" > /home/ubuntu/.ssh/id_ed25519.pub
  - chown ubuntu:ubuntu /home/ubuntu/.ssh/id_ed25519.pub
  - chmod 644 /home/ubuntu/.ssh/id_ed25519.pub

  # 5. Créer authorized_keys avec la clé publique
  - echo "${authorized_keys}" > /home/ubuntu/.ssh/authorized_keys
  - chown ubuntu:ubuntu /home/ubuntu/.ssh/authorized_keys
  - chmod 600 /home/ubuntu/.ssh/authorized_keys

  # 6. Activer et démarrer SSH (évite le service inactif)
  - systemctl enable ssh
  - systemctl restart ssh

  # 7. Cloner le repo GitHub avec playbooks
  - sudo -u ubuntu git clone --branch ${github_repo_branch} ${github_repo_url} /home/ubuntu/ansible-repo || true

  # 8. Configurer SSH pour la connexion vers Web VM (accepter clés inconnues)
  - echo "Host ${web_ip}" > /home/ubuntu/.ssh/config
  - echo "  HostName ${web_ip}" >> /home/ubuntu/.ssh/config
  - echo "  User debian" >> /home/ubuntu/.ssh/config
  - echo "  StrictHostKeyChecking no" >> /home/ubuntu/.ssh/config
  - echo "  UserKnownHostsFile=/dev/null" >> /home/ubuntu/.ssh/config
  - echo "  IdentityFile /home/ubuntu/.ssh/id_ed25519" >> /home/ubuntu/.ssh/config
  - chown ubuntu:ubuntu /home/ubuntu/.ssh/config
  - chmod 600 /home/ubuntu/.ssh/config

  # 9. Attendre que la VM Web soit accessible
  - sleep 30

  # 10. Lancer ansible-playbook automatiquement
  - sudo -u ubuntu /usr/bin/ansible-playbook /home/ubuntu/ansible-repo/playbook.yml -i /home/ubuntu/ansible-repo/inventory.ini 2>&1 | tee /tmp/ansible-playbook.log &

# Logging
output:
  all: '| tee -a /var/log/cloud-init-output.log'
